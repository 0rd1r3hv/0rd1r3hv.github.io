<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Getting Your Phone Unlocked | Ordirehv's Blog</title><meta name="author" content="Ordirehv"><meta name="copyright" content="Ordirehv"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="你的手机安全吗？">
<meta property="og:type" content="article">
<meta property="og:title" content="Getting Your Phone Unlocked">
<meta property="og:url" content="https://0rd1r3hv.github.io/posts/getting-your-phone-unlocked/">
<meta property="og:site_name" content="Ordirehv&#39;s Blog">
<meta property="og:description" content="你的手机安全吗？">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://0rd1r3hv.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2025-04-18T08:09:01.000Z">
<meta property="article:modified_time" content="2025-04-20T04:38:56.226Z">
<meta property="article:author" content="Ordirehv">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="MTK">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://0rd1r3hv.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://0rd1r3hv.github.io/posts/getting-your-phone-unlocked/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Getting Your Phone Unlocked',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-04-20 12:38:56'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: linear-gradient(180deg, rgba(2,0,36,0.5) 90%, rgba(2,0,36,0) 100%);"><nav id="nav"><span id="blog-info"><a href="/" title="Ordirehv's Blog"><span class="site-name">Ordirehv's Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Getting Your Phone Unlocked</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-18T08:09:01.000Z" title="发表于 2025-04-18 16:09:01">2025-04-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-20T04:38:56.226Z" title="更新于 2025-04-20 12:38:56">2025-04-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Reverse/">Reverse</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>8分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Getting Your Phone Unlocked"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="攻陷你的安卓设备：自底向上方法"><a href="#攻陷你的安卓设备：自底向上方法" class="headerlink" title="攻陷你的安卓设备：自底向上方法"></a>攻陷你的安卓设备：自底向上方法</h1><p>对于一般用户而言，ivib一直以来是客制化难度最高的安卓手机品牌之一。</p>
<p>对于禁止BL锁解除，ivib官方说法是出于安全考虑，但是乖乖听话，你的设备真的就会安全吗？</p>
<p>本文以笔者手上的ivib F12为例（CPU为MT6891），讨论如何从底层代码漏洞出发攻陷你的（MTK）安卓设备。</p>
<h2 id="MTK平台启动过程简述"><a href="#MTK平台启动过程简述" class="headerlink" title="MTK平台启动过程简述"></a>MTK平台启动过程简述</h2><p>设备上电后跳转至Boot ROM，进行USB握手，随后用根密钥检验Preloader签名并将其载入SRAM。</p>
<p>Preloader初始化DRAM、闪存和必要的设备，<strong>从闪存读取<code>seccfg</code>分区初始化Secure Boot配置，进行USB握手</strong>，初始化TrustZone，检验Little Kernel（Bootloader）签名，将其加载到DRAM并跳转。</p>
<p>LK根据Secure Boot配置决定是否校验内核并加载到DRAM，随后就是安卓系统的启动流程了。</p>
<img src="/posts/getting-your-phone-unlocked/mtk-boot-process.jpg" class="" title="MTK启动过程">
<h2 id="想法"><a href="#想法" class="headerlink" title="想法"></a>想法</h2><p>作为闭源代码，移动设备芯片的BROM通常有大量未公开的漏洞（掌握在黑灰产手里了），且<strong>一经出厂无法修复</strong>。当然针对MTK BROM也有很多公开的exp，比如<a target="_blank" rel="noopener" href="https://github.com/bkerler/mtkclient">mtkclient</a>。</p>
<p>对出厂设备来说，唯一的补救方法就是<strong>推送修补过的Preloader</strong>，从而<strong>禁止BROM模式</strong>。ivib就对BROM进入作了限制，似乎只有完全放电后，再启动设备才可能进入BROM（我还没成功过）。</p>
<p>LK通常带有解锁Bootloader的功能（即<strong>关闭启动分区校验</strong>），从而允许用户加载自定义的内核（但是ivib的LK没有），而且解锁后会清空手机数据，攻击者无法通过这种手段提取用户数据。并且LK工作在<strong>EL1</strong>下，没有写<code>seccfg</code>分区的权限，即使利用漏洞成功启动也不能持久化。</p>
<p>那么要进行客制化就只能<strong>从Preloader入手</strong>了。Preloader（和BROM）工作在<strong>EL3</strong>下，有最高的权限并且能够<strong>直接操作物理内存</strong>，这里的任何漏洞都可能引发极为严重的安全问题。</p>
<h2 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h2><p>由于手机厂商通常公开发布固件包，获取Preloader分区的镜像异常容易，接下来我只需要找到Preloader的基址和Header长度就能愉快地反编译了。</p>
<p>经过一番搜寻，我找到了<a target="_blank" rel="noopener" href="https://github.com/YuzukiHD/TinyVision/blob/ba3bae2cc6af787854635e7bb68399aee99cfd53/boot/u-boot-2023/tools/mtk_image.h#L153">Header的定义</a>（虽然没有完全对应上），得到加载地址<code>0x00200F10</code>和偏移<code>0xF0</code>。</p>
<p>Github上还能找到一堆<a target="_blank" rel="noopener" href="https://github.com/abodev144/preloader">过往芯片的Preloader源码</a>，经过一些交叉引用的比对可以定位一些关键函数。</p>
<p>其中就包括<code>usbdl_handler</code>，它负责处理USB控制指令，通过它我们可以利用<code>mtkclient</code>实现好的USB协议和设备交互，BROM下也有相同的功能，只是它的漏洞更多。</p>
<p>其中最显眼的指令无非就是<code>CMD_SEND_DA</code>，<code>CMD_JUMP_DA</code>，<code>CMD_READ16</code>，<code>CMD_WRITE16</code>，这几个了，直觉告诉你这里边必出问题。</p>
<p><code>CMD_SEND_DA</code>加载用户发送的DA（Download Agent）程序用于刷写闪存；<code>CMD_JUMP_DA</code>则让Preloader跳转执行DA。</p>
<h3 id="CMD-SEND-DA"><a href="#CMD-SEND-DA" class="headerlink" title="CMD_SEND_DA"></a>CMD_SEND_DA</h3><p>近年MTK设备的Preloader都有<strong>SLA</strong>（Serial Link Authentication）和<strong>DAA</strong>（Download Agent Authentication）机制，分别负责保证<code>CMD_SEND_DA</code>的<strong>调用者是授权用户</strong>（如售后）和<strong>检验DA文件的签名</strong>。我们可以看看它们是如何起作用的。</p>
<img src="/posts/getting-your-phone-unlocked/SLA-DAA.png" class="" title="SLA&#x2F;DAA">
<p>该设备没有SLA，只对DA签名进行验证。先检查DAA是否被开启，随后加载公钥验签，出现错误就进入<code>assert</code>里的死循环。</p>
<p>这里有一个问题在于，<strong>验签之前DA就已经被载入内存并且没有检验DA长度是否合法</strong>。</p>
<img src="/posts/getting-your-phone-unlocked/usbdl_get_data.png" class="" title="usbdl_get_data">
<p><code>dlcomport-&gt;ops-&gt;recv</code>根据使用的协议（USB/UART）调用<code>usb_recv</code>或者<code>uart_recv</code>接收传入数据并写入内存，而它们都没有检验写入地址和<strong>长度的合法性</strong>。<code>da_addr</code>原本可以由用户自由传入，这里直接写死成<code>0x40200000</code>，但是毛用没有。</p>
<p>其实我们已经可以利用它任意操纵32位地址的物理内存了，尽管BROM在低地址且不可写，但是这是因为ROM本来就不支持写操作，不会造成任何异常。只不过这样做要覆写低地址会非常慢，得通过小水管写几个G。</p>
<h3 id="CMD-JUMP-DA"><a href="#CMD-JUMP-DA" class="headerlink" title="CMD_JUMP_DA"></a>CMD_JUMP_DA</h3><p>除了检验<code>g_da_verified</code>为1（SLA和DAA通过之后设置为1）以外没有任何检查，然后跳到<code>0x40200000</code>，单拎出来没啥问题。</p>
<h3 id="CMD-READ16-CMD-WRITE16"><a href="#CMD-READ16-CMD-WRITE16" class="headerlink" title="CMD_READ16/CMD_WRITE16"></a>CMD_READ16/CMD_WRITE16</h3><p>下面是<code>usbdl_write16</code>的代码，<code>usbdl_read16</code>差不多，它竟然会检查<code>len16</code>的<code>int</code>值是否为负——<strong>那可太安全了</strong>；它竟然会调用<code>sec_region_check</code>检查读写区域是否合法——<strong>那可太安全了</strong>。</p>
<img src="/posts/getting-your-phone-unlocked/usbdl_write16.png" class="" title="usbdl_write16">
<p><code>sec_region_check</code>调用<code>while_list_check</code>检查读写区域是否落在一个硬编码的白名单中。</p>
<p><code>while_list_check</code>调用<code>is_in_region</code>检查<strong>区域是否落在某个区间内</strong>，这里<strong>可以溢出</strong>，将<code>base_addr</code>设置为<code>0xFFFFFFFE</code>就能<strong>任意读写</strong>。</p>
<img src="/posts/getting-your-phone-unlocked/is_in_region.png" class="" title="is_in_region">
<p>那就能dump出BROM（<code>0x00000000-0x0001FFFF</code>）并对Preloader进行修补了，我看互联网上好像还没有流传MT6891的BROM。</p>
<h3 id="解锁"><a href="#解锁" class="headerlink" title="解锁"></a>解锁</h3><p>实际利用的时候发现从<code>0x0020E000</code>开始的一段内存写入就会使Preloader崩溃，原因未知。</p>
<p>需要优雅一些的方式在利用这些漏洞的同时保证Preloader<strong>完全正常运行</strong>，否则一旦后续刷写闪存时发生错误就难以挽救，因此我们不应随意污染栈的内容。</p>
<p>一开始看到<code>usbdl_handler</code>里还有被<strong>内联</strong>的<code>usbdl_write32</code>，心想只要发送<code>CMD_READ16</code>把内存dump出来再通过<code>CMD_WRITE32</code>在<strong>上一个栈帧</strong>把patch过的Preloader写回，就<strong>不会对栈和寄存器产生任何副作用</strong>。</p>
<p>但这样做<strong>忽略了指令Cache的存在</strong>，它导致<code>usbdl_handler</code>中执行的指令仍然是未被修补的。</p>
<p>那似乎只能去操纵返回地址了，<code>usbdl_write32</code>被内联在死循环里，那只能考虑<code>usbdl_write16</code>了。</p>
<p>调用链为<code>main-&gt;usb_listen-&gt;usbdl_handler-&gt;usbdl_write16</code>，可以让<code>usbdl_write16</code>跳转到修改白名单的payload，再跳到<code>usbdl_handler</code>结尾，跳回<code>usb_listen</code>结尾，再跳转到<code>usb_listen</code>的入口。这样就不会污染栈和寄存器（payload里应只操作<code>R4-R7</code>寄存器）并且允许我们再次连接设备。</p>
<p>经测试SLA和DAA的状态被写在ROM中，无法修改。但是可以直接操纵<code>g_da_verified</code>为1，再用<code>CMD_WRITE16/32</code>将DA写入，最后调用<code>CMD_JUMP_DA</code>。</p>
<p>之后就能直接<strong>刷写闪存</strong>了，<code>mtkclient</code>提供的DA包含了解锁功能，但我们还是看看<code>seccfg</code>分区的结构。</p>
<p>虽然这个分区有8MB，但是实际只会用到<code>0x3C</code>字节的Header。</p>
<img src="/posts/getting-your-phone-unlocked/seccfg.png" class="" title="seccfg">
<p>它以<code>0x4D4D4D4D</code>开头，<code>0x45454545</code>结束，之间分别代表<code>seccfg</code>的版本、大小、Bootloader解锁状态（<code>LKS</code>），<code>dm-verity</code>状态（<code>verity_state</code>），Secure Boot状态（<code>SBOOT_RUNTIME</code>）。注意<code>mtkclient</code>在解锁的时候把<code>verity_state</code>设置成了<code>DM_VERITY_GENERAL_ERROR (1)</code>，需要改成<code>DM_VERITY_STATUS_OK (0)</code>。</p>
<img src="/posts/getting-your-phone-unlocked/reset_seccfg.png" class="" title="reset_seccfg">
<p>最后是校验序列，可以<strong>逆向<code>sec_seccfg_init</code>得到校验逻辑</strong>，这些函数Github上似乎没有源代码。它对最后<code>0x20</code>字节进行<strong>软/硬件解密</strong>并检查是否和前<code>0x1C</code>的<strong>完整性校验值</strong>是否相同，由常数可以判断使用<strong>SHA256</strong>。</p>
<img src="/posts/getting-your-phone-unlocked/sec_seccfg_init.png" class="" title="sec_seccfg_init">
<p>本设备使用<strong>硬件加解密</strong>，在这种模式下会配置加密模块寄存器的值并与其交互。</p>
<img src="/posts/getting-your-phone-unlocked/decrypt.png" class="" title="decrypt">
<p>交互的逻辑<a target="_blank" rel="noopener" href="https://github.com/bkerler/mtkclient/blob/e9fcf97fd20876f1d950a8c5d37aa7d16ee87caf/mtkclient/Library/Hardware/hwcrypto_sej.py">已经被<code>mtkclient</code>实现了</a>，这个硬件模块叫<code>Security Engine for JTAG protection</code>，<strong>但是这种东西是怎么被逆向出来的？？？？？</strong></p>
<p>你注意到了吗，这样解锁就<strong>不会清空设备数据</strong>了，并且获得权限后攻击者就能用各种方式<strong>提取用户的隐私信息</strong>。</p>
<h2 id="Chores"><a href="#Chores" class="headerlink" title="Chores"></a>Chores</h2><p>如果你想客制化的话，也许会以为到这就结束了？不存在的，ivib还有一斤大的要喂给你吃。</p>
<h3 id="There’s-a-Hole-In-My-Kernel"><a href="#There’s-a-Hole-In-My-Kernel" class="headerlink" title="There’s a Hole In My Kernel"></a>There’s a Hole In My Kernel</h3><p>ivib对Linux进行了魔改，我们想要完成客制化还得在<strong>内核</strong>上动点手脚。</p>
<h4 id="To-Root-or-Not-to-Root"><a href="#To-Root-or-Not-to-Root" class="headerlink" title="To Root or Not to Root"></a>To Root or Not to Root</h4><p>用户如果刷入Magisk修补过的<code>boot</code>分区将<strong>无法正常启动</strong>，或者无法获取root权限。很多用户在没有限制BROM进入的老设备上利用<code>mtkclient</code>成功解锁，但是之后还是死在这一步了。</p>
<p>经测试发现似乎只是在检查待执行的程序名是否为<code>&quot;su&quot;</code>，如果是直接报错<code>&quot;Operation not permitted&quot;</code>。</p>
<p>可以用<code>magiskboot</code>解包<code>boot.img</code>得到<code>vmlinux</code>（注意还有个大小为<code>0x60</code>的Header），用<code>kallsyms-finder</code>解压出符号表再导入IDA就能愉快分析了。当然程序员还不至于这么笨，搜个<code>&quot;su&quot;</code>就能定位？不存在的。</p>
<p>之后搜索<code>exec</code>相关函数发现全都被strip掉了，搜几个别的系统调用发现只有<code>exec</code>相关的被strip掉了——真是<strong>此地无银三百两</strong>。这样就要用到一个<a href="elixir.bootlin.com">查找Linux内核代码交叉引用的网站</a>了。</p>
<p>随意翻翻，找到个<code>do_execveat_common</code>中用到的字符串<code>&quot;/dev/fd/%d/%s&quot;</code>，发现<strong>史就是在这里拉的</strong>，调用了一个函数进行一些怪异的检查，其中就包括<strong>文件名是否为<code>&quot;su&quot;</code></strong>。</p>
<img src="/posts/getting-your-phone-unlocked/check_filename_is_su.png" class="" title="check_filename_is_su">
<h4 id="Security-Blunted-Linux-SBLinux"><a href="#Security-Blunted-Linux-SBLinux" class="headerlink" title="Security-Blunted Linux (SBLinux)"></a>Security-Blunted Linux (SBLinux)</h4><p>尝试在设备上运行<code>frida-server</code>，得到报错<code>&quot;Unable to save SELinux policy to the kernel: Operation not permitted&quot;</code>。</p>
<p>要知道Linux报错一般都会有更加具体的原因，而不是和之前执行<code>su</code>一样笼统的<code>EPERM</code>，这只能说明这段代码<strong>根本就不是Linux维护者写的</strong>。</p>
<p><code>frida-server</code>会通过<strong>写入<code>/sys/fs/selinux/load</code></strong>的方式加载新的SELinux规则保证自身的权限。基于之前<code>su</code>的经验，我查看了<code>open</code>，<code>write</code>系统调用相关的代码，不过似乎没有改动。</p>
<p>那么土应该就动在<strong>SELinux</strong>头上了。<code>/sys/fs/selinux</code>是SELinux的<code>sysfs</code>接口挂载点，<code>/sys/fs/selinux/load</code>是加载安全规则的接口，它的<code>write</code>操作被绑定到了<strong><code>security_load_policy</code></strong>上。一看发现确实加了料，直接<code>NOP</code>掉，不过里面的判断逻辑确实没咋看懂。</p>
<img src="/posts/getting-your-phone-unlocked/security_load_policy.png" class="" title="security_load_policy">
<h3 id="The-Big-Bloatware-Is-Watching-You"><a href="#The-Big-Bloatware-Is-Watching-You" class="headerlink" title="The Big Bloatware Is Watching You"></a>The Big Bloatware Is Watching You</h3><p>除了内核上的改动，ivib还在内置<strong>Bloatware</strong>里加了一些条条框框。你要不要看看这是什么？</p>
<img src="/posts/getting-your-phone-unlocked/lol.png" class="" title="lol">
<p>在ivib服务里找字符串再定位几下应该就好了。比较搞笑的是它用了<strong>相当多的手段</strong>来判断设备是否解锁，但是最后全落到这个函数来更改系统设置变量并发送通知，把它Hook掉就解决了。</p>
<img src="/posts/getting-your-phone-unlocked/setUnlockState.png" class="" title="setUnlockState">
<h2 id="个人建议"><a href="#个人建议" class="headerlink" title="个人建议"></a>个人建议</h2><ul>
<li>尽可能少使用闭源代码以便公开审计</li>
<li>你能做的只有增删模块而不是改动内核的关键函数</li>
<li>要闭源要”安全“就直接对推送的更新镜像加密，增加攻击成本</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://0rd1r3hv.github.io">Ordirehv</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://0rd1r3hv.github.io/posts/getting-your-phone-unlocked/">https://0rd1r3hv.github.io/posts/getting-your-phone-unlocked/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://0rd1r3hv.github.io" target="_blank">Ordirehv's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/MTK/">MTK</a></div><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ordirehv</div><div class="author-info__description">Maho Shojo creeping in CS.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/0rd1r3hv" target="_blank" title="Github"><i class="fab fa-github" style="color: #4a7dbe;"></i></a><a class="social-icon" href="mailto:ord1r3hv@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E9%99%B7%E4%BD%A0%E7%9A%84%E5%AE%89%E5%8D%93%E8%AE%BE%E5%A4%87%EF%BC%9A%E8%87%AA%E5%BA%95%E5%90%91%E4%B8%8A%E6%96%B9%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">攻陷你的安卓设备：自底向上方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MTK%E5%B9%B3%E5%8F%B0%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E7%AE%80%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">MTK平台启动过程简述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%83%B3%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">想法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D"><span class="toc-number">1.3.</span> <span class="toc-text">实操</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CMD-SEND-DA"><span class="toc-number">1.3.1.</span> <span class="toc-text">CMD_SEND_DA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CMD-JUMP-DA"><span class="toc-number">1.3.2.</span> <span class="toc-text">CMD_JUMP_DA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CMD-READ16-CMD-WRITE16"><span class="toc-number">1.3.3.</span> <span class="toc-text">CMD_READ16&#x2F;CMD_WRITE16</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%94%81"><span class="toc-number">1.3.4.</span> <span class="toc-text">解锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chores"><span class="toc-number">1.4.</span> <span class="toc-text">Chores</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#There%E2%80%99s-a-Hole-In-My-Kernel"><span class="toc-number">1.4.1.</span> <span class="toc-text">There’s a Hole In My Kernel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#To-Root-or-Not-to-Root"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">To Root or Not to Root</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Security-Blunted-Linux-SBLinux"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">Security-Blunted Linux (SBLinux)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Big-Bloatware-Is-Watching-You"><span class="toc-number">1.4.2.</span> <span class="toc-text">The Big Bloatware Is Watching You</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AA%E4%BA%BA%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.5.</span> <span class="toc-text">个人建议</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/getting-your-phone-unlocked/" title="Getting Your Phone Unlocked">Getting Your Phone Unlocked</a><time datetime="2025-04-18T08:09:01.000Z" title="发表于 2025-04-18 16:09:01">2025-04-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/os-toy-lab-1/" title="操作系统课设实验一">操作系统课设实验一</a><time datetime="2024-10-29T15:06:19.000Z" title="发表于 2024-10-29 23:06:19">2024-10-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/sys-toy-experiment/" title="计算机组织与体系结构课程设计">计算机组织与体系结构课程设计</a><time datetime="2024-10-20T13:45:50.000Z" title="发表于 2024-10-20 21:45:50">2024-10-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/moectf-2024-reverse/" title="MoeCTF 2024 Reverse">MoeCTF 2024 Reverse</a><time datetime="2024-10-10T13:11:47.000Z" title="发表于 2024-10-10 21:11:47">2024-10-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/rth-roots-over-finite-fields/" title="何以求根">何以求根</a><time datetime="2024-09-06T14:31:34.000Z" title="发表于 2024-09-06 22:31:34">2024-09-06</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgba(0,0,0,0)"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>